# HLLD Riemann Solver 测试分析报告

## 执行概述

对最新的HLLD黎曼求解器实现进行了三个标准基准测试，目的是验证OpenMHD等价性修复和能量守恒性能。

**测试日期**: 2025-11-18
**HLLD版本**: commit b53c6a2 (OpenMHD等价性修复)
**网格分辨率**: Brio-Wu (128×2×2), Orszag-Tang (96×96×2)

---

## 测试结果总结

| 测试用例 | 状态 | 能量演化 | 数值稳定性 | 最终时间 |
|---------|------|--------|----------|---------|
| **Brio-Wu 激波管** | ❌ 失败 | 4.259e+136 @ step 5000 | 时间步长崩溃 | t=0.02393 |
| **Orszag-Tang 涡旋** | ❌ 失败 | NaN @ step 500 | 能量爆炸 | t=0.2618 |
| **Harris Sheet 3D** | ⏳ 未完成 | - | - | - |

---

## 详细测试分析

### 1. Brio-Wu 磁激波管 (Brio & Wu 1988)

#### 初始条件
```
左侧  (x < 0.5):  ρ=1.0,   p=1.0,   Bx=0.75,  By=1.0
右侧  (x > 0.5):  ρ=0.125, p=0.1,   Bx=0.75,  By=-1.0
```

#### 观察结果

**早期演化** (step 50-200):
- 时间步长: 1.550e-04 → 6.436e-06 (快速衰减)
- 能量: 1.753e-04 → 1.720e-02 (缓慢增长)
- 压力范围: [1e-11, 2.078e+02]

**中期演化** (step 300-1000):
- 时间步长: 2.691e-07 → 1.988e-17 (指数衰减)
- 能量: 9.560e+00 → 2.121e+21 (指数爆炸)
- 时间卡住: t ≈ 2.393e-02 (无法推进)

**终期演化** (step 5000):
- 能量: **4.259e+136** (最终值)
- 时间步长: 4.126e-75 (几乎为零)
- 模拟完成但数值不可信

#### 关键观察
```
能量增长模式:
- Step 100: E_tot = 2.753e-04
- Step 300: E_tot = 9.560e+00      (Δ ≈ 3.5×10⁴)
- Step 500: E_tot = 7.006e+06      (Δ ≈ 7.3×10⁵)
- Step 1000: E_tot = 2.121e+21     (Δ ≈ 3.0×10¹⁴)
- Step 5000: E_tot = 4.259e+136    (几何增长)

时间推进衰减:
dt(100)  = 2.388e-05
dt(200)  = 6.436e-06  (衰减因子 ≈ 0.27)
dt(300)  = 2.691e-07  (衰减因子 ≈ 0.04)
dt(500)  = 3.148e-10  (衰减因子 ≈ 0.0001)
```

### 2. Orszag-Tang 涡旋流 (Orszag & Tang 1979)

#### 初始条件
```
速度场:  u = -sin(y), v = sin(x), w = 0
磁场:    Bx = -sin(y), By = sin(2x), Bz = 0
密度:    ρ = γ² = 2.77778
压力:    p = 1.0
```

#### 观察结果

**早期演化** (step 100):
- 时间: t = 0.2618
- 时间步长: dt = 3.864e-06
- 动能: KE = 3.411e+02 (异常高！)
- 总能量: E_tot = 1.798e+05
- 诊断: 初始条件设置可能有问题

**中期演化** (step 200-400):
- 时间停滞: t = 0.2618 (无推进)
- 时间步长: 3.864e-06 → 1.205e-18 (指数衰减)
- 能量: 1.798e+05 → 2.750e+30 (指数爆炸)

**终期演化** (step 500):
- 能量: **NaN** (浮点溢出)
- 时间步长: 7.747e-23
- 模拟无法继续

#### 关键观察
```
初始动能计算异常:
- 理论最大值: KE_max = 0.5 × ρ × max(u² + v²) = 0.5 × 2.77778 × 2 ≈ 2.78
- 实际值 @ step 100: KE = 3.411e+02
- 偏差: ~122倍！

这表明初始条件初始化或能量计算有严重错误。
```

---

## 问题诊断

### 根本原因分析

#### 1. 共同特征
- ✓ 两个测试都显示**指数能量增长**
- ✓ 都伴随**时间步长指数衰减**
- ✓ 都导致**时间推进停滞**
- ✓ 最终都达到 **NaN 或极端值**

#### 2. 可能的根本原因

**假设A: 中心态能量计算错误**
```cpp
// 当前实现使用单侧能量 + Poynting通量修正
if (S_M >= 0.0) {
    E_central = E_Lstar - sqrt_rho_L * (vdotB_Lstar - vdotB_central) * sign_B;
} else {
    E_central = E_Rstar + sqrt_rho_R * (vdotB_Rstar - vdotB_central) * sign_B;
}
```

问题:
- v·B项可能符号错误
- Poynting通量修正系数可能不匹配
- 单侧vs双侧选择可能不适当

**假设B: 中间态计算问题**
```cpp
// compute_state_L() 和 compute_state_R()
double E_Lstar = ((S_L - u_L) * U_L(4) - pt_L * u_L + pt_Lstar * S_M +
                  B_n * (vdotB_L - vdotB_Lstar)) / (S_L - S_M);
```

问题:
- 这个公式可能对高度磁化流体不适用
- Poynting通量项的定义可能不正确
- 在强磁场情况下数值精度可能失效

**假设C: 重建或限制器问题**
- minmod限制器可能过度限制导致虚假振荡
- 高阶MUSCL重建可能在磁场中引入不稳定性
- 没有对正性保证的处理

**假设D: CFL条件不够保守**
- CFL = 0.4 对于MHD + MUSCL可能太大
- 强磁场情况下需要更小的CFL
- 时间积分RK2可能在接近激波时不稳定

### 版本对比

测试了多个HLLD版本:

| 版本 | Brio-Wu 结果 | Orszag-Tang 结果 |
|------|-------------|-----------------|
| 原始 (705056b) | NaN @ step 3450 | NaN @ step ~500 |
| OpenMHD修复 (b53c6a2) | 4.259e+136 @ step 5000 | NaN @ step 500 |
| Roe平均能量 | NaN @ step 3100 | NaN @ step ~500 |

**结论**: 问题**不是**由最近的修改引入的，而是**基础性的**。

---

## 性能指标

### 数值稳定性评分 (0-10)

```
Brio-Wu 激波管:
├─ 能量守恒: 0/10 (指数爆炸)
├─ 时间推进: 2/10 (快速停滞)
├─ 压力正性: 8/10 (保持正)
├─ 散度清理: 10/10 (完美)
└─ 总体: 5/10 ❌

Orszag-Tang 涡旋:
├─ 能量守恒: 0/10 (指数爆炸)
├─ 时间推进: 1/10 (几乎无法推进)
├─ 压力正性: 5/10 (偶发NaN)
├─ 散度清理: 10/10 (完美)
└─ 总体: 4/10 ❌
```

---

## 建议的修复方向

### 短期 (立即)
1. **调查compute_state_L/R()中的能量公式**
   - 验证Poynting通量项的符号和系数
   - 与OpenMHD源代码逐行对比

2. **降低CFL数**
   - 将CFL从0.4降低到0.1
   - 测试时间步长是否增加

3. **加强初始条件检查**
   - 验证Orszag-Tang初始动能计算
   - 添加能量守恒诊断

### 中期 (1-2周)
1. **实现更好的limiter**
   - 考虑MC(monotonized central)或TVB限制
   - 添加positivity preserving reconstruction

2. **提高时间积分精度**
   - 尝试3阶RK而不是2阶
   - 添加显式能量稳定项

3. **对比参考实现**
   - 与ATHENA++或PLUTO HLLD对比
   - 逐细胞调试问题区域

### 长期 (3-4周)
1. **完整的HLLD验证套件**
   - 添加标准Sod问题(纯气体)
   - 添加更多MHD激波管变体
   - 添加smooth flow测试

2. **性能优化**
   - 向量化关键循环
   - 并行化Riemann求解

---

## 结论

### 主要发现
1. **HLLD求解器存在基础性数值不稳定性**，不是由最近修改引入
2. **能量守恒严重违反**，偏离Riemann求解器的核心保证
3. **问题影响所有测试案例**，表明根本原因而非特例

### 临床表现
- 指数能量增长 (E_tot ∝ 10^(n×steps))
- 时间步长指数衰减 (dt ∝ 10^(-n×steps))
- CFL限制导致时间推进停滞
- 最终达到浮点溢出

### 下一步行动
需要在以下几个方向同时进行深入调查:
1. 核心Riemann求解公式 (尤其是能量项)
2. 中间态计算的数值实现
3. 初始条件和重建方案
4. 与参考实现的详细对比

---

## 附录: 测试日志

### Brio-Wu 完整日志
```
见: /tmp/brio_wu_output_corrected.txt
主要指标: 5000步, 能量从1.753e-04增长到4.259e+136
```

### Orszag-Tang 完整日志
```
见: /tmp/orszag_tang_output.txt
主要指标: 657步, 能量在step 500达到NaN
```

---

*报告生成时间: 2025-11-18*
*HLLD版本: commit b53c6a2*
*测试框架: FVM3D MHD Solver*
